<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alta Pro - Bank Grade Editor</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <style>
    :root { --bg:#f1f5f9; --panel:#fff; --accent:#cceeff; --primary:#0066cc; }
    * { box-sizing: border-box; user-select: none; }
    body { margin:0; font-family:'Inter',sans-serif; background:var(--bg); height:100vh; display:flex; flex-direction:column; overflow:hidden; }

    /* RIBBON */
    .ribbon { background:var(--panel); border-bottom:1px solid #cbd5e1; height:90px; display:flex; align-items:center; padding:0 15px; gap:8px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.05); z-index:50; }
    .brand { font-weight:800; font-size:20px; color:#0f172a; margin-right:15px; border-right:1px solid #ddd; padding-right:15px; height:50px; display:flex; align-items:center; }
    
    .tool-group { display:flex; gap:5px; padding-right:10px; border-right:1px solid #eee; height:60px; align-items:center; }
    .tool-group:last-child { border:none; }

    .btn { display:flex; flex-direction:column; align-items:center; justify-content:center; width:60px; height:100%; border:1px solid transparent; background:transparent; border-radius:6px; color:#64748b; font-size:11px; font-weight:600; cursor:pointer; gap:4px; }
    .btn i { font-size:18px; }
    .btn:hover { background:#f8fafc; color:var(--primary); }
    .btn.active { background:var(--accent); color:var(--primary); border-color:#99d1f2; }
    .btn:disabled { opacity:0.5; cursor:not-allowed; }

    .btn-icon { width:32px; height:32px; border:1px solid transparent; background:transparent; border-radius:4px; cursor:pointer; color:#475569; display:flex; align-items:center; justify-content:center; }
    .btn-icon:hover { background:#f1f5f9; color:var(--primary); }
    
    /* INPUTS */
    select, input { height:30px; border:1px solid #cbd5e1; border-radius:4px; padding:0 6px; color:#334155; font-size:12px; }

    /* WORKSPACE */
    #workspace { flex:1; background:#475569; overflow:auto; display:flex; justify-content:center; padding:40px; }
    #canvas-container { position:relative; background:white; box-shadow:0 20px 25px -5px rgba(0,0,0,0.5); }
    canvas { position:absolute; top:0; left:0; }
    #ui-layer { z-index:10; cursor:crosshair; }

    /* EDITOR */
    #inline-editor { position:absolute; z-index:100; background:transparent; border:2px dashed var(--primary); outline:none; padding:0; margin:0; resize:none; overflow:hidden; white-space:pre; line-height:1; display:none; transform-origin:top left; }

    /* UPLOAD */
    #upload-overlay { position:fixed; inset:0; z-index:999; background:rgba(255,255,255,0.98); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; }
    #upload-overlay.hidden { display:none; }
    .upload-btn { padding:15px 40px; font-size:16px; font-weight:bold; background:var(--primary); color:white; border:none; border-radius:8px; cursor:pointer; box-shadow:0 4px 6px rgba(0,102,204,0.3); }
    .upload-btn:hover { transform:translateY(-1px); box-shadow:0 6px 8px rgba(0,102,204,0.4); }
  </style>
</head>
<body>

  <div class="ribbon">
    <div class="brand">ALTA</div>
    
    <div class="tool-group">
      <button class="btn" id="btn-open"><i class="fa-regular fa-folder-open"></i>Open</button>
      <button class="btn" id="btn-save" disabled><i class="fa-regular fa-floppy-disk"></i>Save</button>
    </div>

    <div class="tool-group">
      <button class="btn active" data-tool="select"><i class="fa-solid fa-arrow-pointer"></i>Select</button>
      <button class="btn" data-tool="text"><i class="fa-solid fa-font"></i>Text</button>
      <button class="btn" data-tool="whiteout"><i class="fa-solid fa-eraser"></i>Mask</button>
    </div>

    <div class="tool-group" style="flex-direction:row; padding:0 8px;">
      <div style="display:flex; flex-direction:column; gap:4px;">
        <div style="display:flex; gap:4px;">
          <select id="font-family" style="width:120px;">
            <option value="BankCourier">Bank Courier</option>
            <option value="Helvetica">Helvetica</option>
            <option value="Times">Times Roman</option>
          </select>
          <input type="number" id="font-size" value="12" style="width:50px;">
        </div>
        <div style="display:flex; gap:4px; justify-content:center;">
          <button class="btn-icon" id="btn-bold" title="Bold"><i class="fa-solid fa-bold"></i></button>
          <button class="btn-icon" id="btn-delete" title="Delete Selected" style="color:#ef4444;"><i class="fa-solid fa-trash"></i></button>
        </div>
      </div>
    </div>
  </div>

  <div id="workspace">
    <div id="canvas-container">
      <canvas id="pdf-layer"></canvas>
      <canvas id="ui-layer"></canvas>
      <textarea id="inline-editor"></textarea>
    </div>
  </div>

  <div id="upload-overlay">
    <h1 style="color:#0f172a; margin:0;">Load Document</h1>
    <p style="color:#64748b;">Bank Grade Logic â€¢ Secure Processing</p>
    <button class="upload-btn" onclick="document.getElementById('file-in').click()">Choose PDF</button>
  </div>

  <input type="file" id="file-in" accept="application/pdf" style="display:none">

<script>
  // 1. CONFIG
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  const App = {
    pdfBytes: null, pdfDoc: null, pdfLibDoc: null,
    scale: 1.25, pageNum: 1, tool: 'select',
    objects: [], selectedId: null, isEditing: false
  };

  const uiC = document.getElementById('ui-layer');
  const pdfC = document.getElementById('pdf-layer');
  const uiCtx = uiC.getContext('2d');
  const pdfCtx = pdfC.getContext('2d');
  const editor = document.getElementById('inline-editor');

  // 2. INIT
  window.onload = () => {
    document.getElementById('file-in').onchange = e => loadPDF(e.target.files[0]);
    document.getElementById('btn-open').onclick = () => document.getElementById('file-in').click();
    document.getElementById('btn-save').onclick = savePDF;
    document.getElementById('btn-delete').onclick = deleteSelected;

    // Tool switching
    document.querySelectorAll('[data-tool]').forEach(b => {
      b.onclick = () => {
        // Commit any edits before switching
        if(App.isEditing) commitEdit();
        App.tool = b.dataset.tool;
        document.querySelectorAll('[data-tool]').forEach(btn => btn.classList.remove('active'));
        b.classList.add('active');
        uiC.style.cursor = App.tool==='select' ? 'default' : 'crosshair';
        renderUI();
      };
    });

    // Formatting
    ['font-family','font-size'].forEach(id => {
      document.getElementById(id).onchange = updateSelected;
    });
    document.getElementById('btn-bold').onclick = () => {
      document.getElementById('btn-bold').classList.toggle('active');
      updateSelected();
    };

    // Canvas Events
    uiC.onmousedown = onDown;
    uiC.onmousemove = onMove;
    uiC.onmouseup = onUp;
    uiC.ondblclick = onDbl;
    editor.onblur = commitEdit;
  };

  // 3. LOAD PDF (FIXED)
  async function loadPDF(file) {
    if(!file) return;
    try {
      const buf = await file.arrayBuffer();
      App.pdfBytes = buf.slice(0); // CLONE for editor
      App.pdfDoc = await pdfjsLib.getDocument({data: buf}).promise;
      App.pdfLibDoc = await PDFLib.PDFDocument.load(App.pdfBytes);
      
      document.getElementById('upload-overlay').classList.add('hidden');
      document.getElementById('btn-save').disabled = false;
      renderPage();
    } catch(e) { alert("Error: "+e.message); }
  }

  async function renderPage() {
    const page = await App.pdfDoc.getPage(App.pageNum);
    const vp = page.getViewport({scale: App.scale});
    
    // Resize containers
    const cont = document.getElementById('canvas-container');
    cont.style.width = vp.width+'px'; cont.style.height = vp.height+'px';
    pdfC.width = vp.width; pdfC.height = vp.height;
    uiC.width = vp.width; uiC.height = vp.height;

    await page.render({canvasContext: pdfCtx, viewport: vp}).promise;
    renderUI();
  }

  // 4. UI LOGIC
  function renderUI() {
    uiCtx.clearRect(0,0,uiC.width,uiC.height);
    
    App.objects.forEach(o => {
      if(App.isEditing && App.selectedId === o.id) return;
      
      const x=o.x*App.scale, y=o.y*App.scale, w=o.w*App.scale, h=o.h*App.scale;
      
      // Draw Whiteout
      if(o.type === 'whiteout' || o.maskId) { // Masks are white
        uiCtx.fillStyle = '#ffffff';
        uiCtx.fillRect(x,y,w,h);
      }
      
      // Draw Text
      if(o.type === 'text') {
        uiCtx.save();
        let font = 'Helvetica';
        if(o.font === 'BankCourier') font = '"Courier Prime", monospace';
        if(o.font === 'Times') font = '"Times New Roman", serif';
        
        uiCtx.font = `${o.bold?'bold ':''}${o.size*App.scale}px ${font}`;
        uiCtx.fillStyle = '#000';
        uiCtx.textBaseline = 'top';
        uiCtx.fillText(o.text, x, y);
        uiCtx.restore();
      }
    });

    // Selection Box
    if(App.selectedId && !App.isEditing) {
      const o = App.objects.find(i => i.id === App.selectedId);
      if(o) {
        const x=o.x*App.scale, y=o.y*App.scale, w=o.w*App.scale, h=o.h*App.scale;
        uiCtx.strokeStyle = '#0066cc'; uiCtx.lineWidth = 1.5;
        uiCtx.strokeRect(x,y,w,h);
        // Handles
        uiCtx.fillStyle='#cceeff'; 
        [[x,y],[x+w,y],[x,y+h],[x+w,y+h]].forEach(([hx,hy]) => {
          uiCtx.fillRect(hx-3, hy-3, 6, 6);
          uiCtx.strokeRect(hx-3, hy-3, 6, 6);
        });
      }
    }
  }

  // 5. INTERACTION
  let drag = null;
  function getPos(e) {
    const r = uiC.getBoundingClientRect();
    return { x:(e.clientX-r.left)/App.scale, y:(e.clientY-r.top)/App.scale };
  }

  function onDown(e) {
    const {x,y} = getPos(e);
    
    if(App.tool === 'select') {
      // Find clicked object
      const hit = App.objects.slice().reverse().find(o => x>=o.x && x<=o.x+o.w && y>=o.y && y<=o.y+o.h);
      App.selectedId = hit ? hit.id : null;
      if(hit) {
        drag = { type:'move', x, y, ox:hit.x, oy:hit.y };
        syncToolbar(hit);
      }
    } 
    else if(App.tool === 'text') {
      // UX IMPROVEMENT: Create "Type Here" text immediately
      createSmartText(x, y);
    }
    else if(App.tool === 'whiteout') {
      drag = { type:'create', x, y };
    }
    renderUI();
  }

  function onMove(e) {
    const {x,y} = getPos(e);
    if(!drag) return;

    if(drag.type === 'move' && App.selectedId) {
      const o = App.objects.find(i => i.id === App.selectedId);
      o.x = drag.ox + (x - drag.x);
      o.y = drag.oy + (y - drag.y);
      // Move attached mask
      if(o.maskId) {
        const m = App.objects.find(i => i.id === o.maskId);
        if(m) { m.x = o.x; m.y = o.y; }
      }
    }
    renderUI();
  }

  function onUp(e) {
    const {x,y} = getPos(e);
    if(drag && drag.type === 'create') {
      // Finish whiteout creation
      const w = Math.abs(x - drag.x);
      const h = Math.abs(y - drag.y);
      if(w>5 && h>5) {
        App.objects.push({
          id: Date.now(), type: 'whiteout',
          x: Math.min(x, drag.x), y: Math.min(y, drag.y), w, h
        });
      }
    }
    drag = null;
    renderUI();
  }

  function onDbl(e) {
    const {x,y} = getPos(e);
    const hit = App.objects.find(o => o.type==='text' && x>=o.x && x<=o.x+o.w && y>=o.y && y<=o.y+o.h);
    if(hit) {
      App.selectedId = hit.id;
      startEdit(hit);
    }
  }

  // 6. SMART TEXT (FIXED UX)
  function createSmartText(x, y) {
    const id = Date.now();
    const maskId = id + 1;
    
    // 1. Create Mask
    App.objects.push({ id:maskId, type:'whiteout', x, y, w:100, h:20 });
    
    // 2. Create Text with "Type Here"
    const txt = {
      id, type:'text', text:'Type Here', 
      x, y, w:100, h:20, maskId,
      font: document.getElementById('font-family').value,
      size: parseInt(document.getElementById('font-size').value),
      bold: document.getElementById('btn-bold').classList.contains('active')
    };
    App.objects.push(txt);
    
    // 3. Select and Edit immediately
    App.selectedId = id;
    document.querySelector('[data-tool="select"]').click(); // Switch to select mode automatically
    startEdit(txt);
  }

  function startEdit(o) {
    App.isEditing = true;
    editor.style.display = 'block';
    
    // Match editor position/style to canvas object
    editor.style.left = (o.x * App.scale) + 'px';
    editor.style.top = (o.y * App.scale) + 'px';
    editor.style.width = (Math.max(o.w, 50) * App.scale) + 'px';
    editor.style.height = (o.h * App.scale * 1.5) + 'px';
    
    let font = 'Helvetica';
    if(o.font === 'BankCourier') font = '"Courier Prime", monospace';
    if(o.font === 'Times') font = '"Times New Roman", serif';
    
    editor.style.fontFamily = font;
    editor.style.fontSize = (o.size * App.scale) + 'px';
    editor.style.fontWeight = o.bold ? 'bold' : 'normal';
    
    editor.value = o.text;
    editor.select(); // Highlight text so typing replaces it
    editor.focus();
    renderUI();
  }

  function commitEdit() {
    if(!App.isEditing) return;
    const o = App.objects.find(i => i.id === App.selectedId);
    if(o) {
      o.text = editor.value;
      // Auto-resize mask width based on text
      const ctx = document.createElement('canvas').getContext('2d');
      ctx.font = `${o.bold?'bold ':''}${o.size}px ${o.font}`; 
      const width = ctx.measureText(o.text).width + 10;
      o.w = Math.max(width, 20);
      
      // Update mask size
      if(o.maskId) {
        const m = App.objects.find(i => i.id === o.maskId);
        if(m) { m.w = o.w; m.h = o.h; }
      }
    }
    App.isEditing = false;
    editor.style.display = 'none';
    renderUI();
  }

  function deleteSelected() {
    if(!App.selectedId) return;
    const o = App.objects.find(i => i.id === App.selectedId);
    // Delete mask if attached
    if(o && o.maskId) {
      App.objects = App.objects.filter(i => i.id !== o.maskId);
    }
    App.objects = App.objects.filter(i => i.id !== App.selectedId);
    App.selectedId = null;
    renderUI();
  }

  function updateSelected() {
    if(!App.selectedId) return;
    const o = App.objects.find(i => i.id === App.selectedId);
    if(o && o.type === 'text') {
      o.font = document.getElementById('font-family').value;
      o.size = parseInt(document.getElementById('font-size').value);
      o.bold = document.getElementById('btn-bold').classList.contains('active');
      
      // Update mask height if font size changed
      if(o.maskId) {
        o.h = o.size * 1.2;
        const m = App.objects.find(i => i.id === o.maskId);
        if(m) { m.h = o.h; }
      }
      renderUI();
    }
  }

  function syncToolbar(o) {
    if(o.type !== 'text') return;
    document.getElementById('font-family').value = o.font;
    document.getElementById('font-size').value = o.size;
    if(o.bold) document.getElementById('btn-bold').classList.add('active');
    else document.getElementById('btn-bold').classList.remove('active');
  }

  // 7. SAVE
  async function savePDF() {
    if(!App.pdfLibDoc) return;
    const doc = App.pdfLibDoc;
    const page = doc.getPages()[App.pageNum-1];
    const {height} = page.getSize();
    
    // Fonts
    const helv = await doc.embedFont(PDFLib.StandardFonts.Helvetica);
    const helvBold = await doc.embedFont(PDFLib.StandardFonts.HelveticaBold);
    const cour = await doc.embedFont(PDFLib.StandardFonts.Courier);
    const courBold = await doc.embedFont(PDFLib.StandardFonts.CourierBold);
    const times = await doc.embedFont(PDFLib.StandardFonts.TimesRoman);

    for(const o of App.objects) {
      // In PDF-Lib Y starts from bottom
      const y = height - o.y - o.h; 
      
      if(o.type === 'whiteout') {
        page.drawRectangle({ x:o.x, y:y, width:o.w, height:o.h, color: PDFLib.rgb(1,1,1) });
      } else if(o.type === 'text') {
        let font = helv;
        if(o.font === 'BankCourier') font = o.bold ? courBold : cour;
        if(o.font === 'Times') font = times;
        if(o.font === 'Helvetica' && o.bold) font = helvBold;
        
        // Slight Y adjustment for baseline
        page.drawText(o.text, {
          x: o.x,
          y: height - o.y - (o.size*0.85), 
          size: o.size,
          font: font,
          color: PDFLib.rgb(0,0,0)
        });
      }
    }
    
    const bytes = await doc.save();
    const blob = new Blob([bytes], {type:'application/pdf'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'edited_doc.pdf';
    a.click();
  }
</script>
</body>
</html>

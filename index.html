<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alta Pro - Debug Mode</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <style>
    /* BASIC STYLING TO ENSURE VISIBILITY */
    body { margin: 0; font-family: 'Inter', sans-serif; background: #f1f5f9; height: 100vh; display: flex; flex-direction: column; }
    .ribbon { background: white; height: 100px; display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid #ccc; gap: 10px; }
    .btn-large { height: 80px; padding: 0 15px; border: 1px solid transparent; background: transparent; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; font-size: 12px; font-weight: 600; border-radius: 6px; }
    .btn-large:hover { background: #f0f9ff; color: #0066cc; }
    .btn-large i { font-size: 24px; margin-bottom: 5px; }
    .btn-large.active { background: #e0f2fe; color: #0066cc; border: 1px solid #bae6fd; }
    
    #workspace { flex: 1; background: #475569; overflow: auto; display: flex; justify-content: center; padding: 40px; }
    #canvas-container { position: relative; background: white; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    canvas { position: absolute; top: 0; left: 0; }
    #ui-layer { z-index: 10; }
    
    #upload-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 999; }
    #upload-overlay.hidden { display: none; }
    .big-btn { padding: 15px 30px; font-size: 18px; background: #0066cc; color: white; border: none; border-radius: 8px; cursor: pointer; }
    
    #inline-editor { position: absolute; z-index: 100; background: transparent; border: 1px dashed #0066cc; outline: none; padding: 0; margin: 0; resize: none; overflow: hidden; display: none; line-height: 1.15; transform-origin: top left; }
  </style>
</head>
<body>

  <div class="ribbon">
    <h2 style="margin-right:20px; color:#0f172a;">ALTA</h2>
    <button class="btn-large" id="btn-open"><i class="fa-regular fa-folder-open"></i>Open</button>
    <button class="btn-large" id="btn-save" disabled><i class="fa-regular fa-floppy-disk"></i>Save</button>
    <div style="width:1px; height:60px; background:#ddd; margin:0 10px;"></div>
    <button class="btn-large active" data-tool="select" id="tool-select"><i class="fa-solid fa-arrow-pointer"></i>Select</button>
    <button class="btn-large" data-tool="text" id="tool-text"><i class="fa-solid fa-font"></i>Text</button>
    <button class="btn-large" data-tool="whiteout"><i class="fa-solid fa-eraser"></i>Erase</button>
    
    <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
      <select id="font-family" style="height:30px;"><option value="BankCourier">Bank Courier</option><option value="Helvetica">Helvetica</option></select>
      <input type="number" id="font-size" value="12" style="width:50px; height:30px;">
      <button class="btn-large" id="btn-bold" style="height:40px; width:40px;"><i class="fa-solid fa-bold" style="font-size:14px; margin:0;"></i></button>
    </div>
  </div>

  <div id="upload-overlay">
    <h1>Bank Grade Editor</h1>
    <button class="big-btn" onclick="document.getElementById('file-input').click()">Select PDF File</button>
    <p style="margin-top:20px; color:#666;">v3.0 - Debug Mode</p>
  </div>

  <div id="workspace">
    <div id="canvas-container">
      <canvas id="pdf-layer"></canvas>
      <canvas id="ui-layer"></canvas>
      <textarea id="inline-editor"></textarea>
    </div>
  </div>

  <input type="file" id="file-input" accept="application/pdf" style="display:none" />

<script>
  // WORKER SETUP
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  const App = {
    pdfBytes: null, pdfDoc: null, pdfLibDoc: null,
    scale: 1.25, pageNum: 1, tool: 'select',
    objects: [], selectedId: null, isEditing: false
  };

  const uiCanvas = document.getElementById('ui-layer');
  const pdfCanvas = document.getElementById('pdf-layer');
  const uiCtx = uiCanvas.getContext('2d');
  const pdfCtx = pdfCanvas.getContext('2d');
  const editor = document.getElementById('inline-editor');

  // --- STARTUP ---
  window.onload = () => {
    console.log("App Started");
    
    // Wire up buttons
    document.getElementById('file-input').addEventListener('change', (e) => loadPDF(e.target.files[0]));
    document.getElementById('btn-open').addEventListener('click', () => document.getElementById('file-input').click());
    document.getElementById('btn-save').addEventListener('click', savePDF);
    
    // Tools
    ['select','text','whiteout'].forEach(t => {
      const btn = document.querySelector(`[data-tool="${t}"]`);
      if(btn) btn.onclick = () => setTool(t);
    });

    // Formatting
    document.getElementById('font-family').onchange = updateProp;
    document.getElementById('font-size').onchange = updateProp;
    document.getElementById('btn-bold').onclick = () => {
      document.getElementById('btn-bold').classList.toggle('active');
      updateProp();
    };

    // Canvas Events
    uiCanvas.onmousedown = onMouseDown;
    uiCanvas.onmousemove = onMouseMove;
    uiCanvas.onmouseup = onMouseUp;
    uiCanvas.ondblclick = onDoubleClick;
    editor.onblur = commitEdit;
  };

  // --- CORE LOAD FUNCTION (WITH ALERTS) ---
  async function loadPDF(file) {
    if(!file) return;
    
    // STEP 1
    // alert("Step 1: Reading File..."); // Uncomment if needed
    
    try {
      const rawBuffer = await file.arrayBuffer();
      
      // STEP 2: CLONE
      App.pdfBytes = rawBuffer.slice(0); 
      
      // STEP 3: VIEWER
      App.pdfDoc = await pdfjsLib.getDocument({data: rawBuffer}).promise;
      
      // STEP 4: EDITOR
      App.pdfLibDoc = await PDFLib.PDFDocument.load(App.pdfBytes);
      
      // STEP 5: SUCCESS
      // alert("Success! Rendering now...");
      
      document.getElementById('upload-overlay').classList.add('hidden');
      document.getElementById('btn-save').disabled = false;
      App.objects = [];
      renderPage();
      
    } catch(e) {
      alert("ERROR: " + e.message);
      console.error(e);
    }
  }

  async function renderPage() {
    const page = await App.pdfDoc.getPage(App.pageNum);
    const viewport = page.getViewport({scale: App.scale});
    
    const container = document.getElementById('canvas-container');
    container.style.width = viewport.width + "px";
    container.style.height = viewport.height + "px";
    
    pdfCanvas.width = viewport.width; pdfCanvas.height = viewport.height;
    uiCanvas.width = viewport.width; uiCanvas.height = viewport.height;
    
    await page.render({canvasContext: pdfCtx, viewport}).promise;
    renderUI();
  }

  function renderUI() {
    uiCtx.clearRect(0,0,uiCanvas.width,uiCanvas.height);
    
    App.objects.forEach(o => {
      if(App.isEditing && App.selectedId === o.id) return; // Hide if editing
      
      const x=o.x*App.scale, y=o.y*App.scale, w=o.w*App.scale, h=o.h*App.scale;
      
      if(o.type === 'whiteout') {
        uiCtx.fillStyle = '#ffffff';
        uiCtx.fillRect(x,y,w,h);
      } else if(o.type === 'text') {
        uiCtx.save();
        let font = 'Helvetica';
        if(o.font === 'BankCourier') font = '"Courier Prime", monospace';
        if(o.font === 'Times') font = '"Times New Roman", serif';
        
        uiCtx.font = `${o.bold?'bold ':''}${o.size*App.scale}px ${font}`;
        uiCtx.fillStyle = '#000';
        uiCtx.textBaseline = 'top';
        uiCtx.fillText(o.text, x, y);
        uiCtx.restore();
      }
    });
    
    // Selection Box
    if(App.selectedId && !App.isEditing) {
      const o = App.objects.find(i => i.id === App.selectedId);
      if(o) {
        const x=o.x*App.scale, y=o.y*App.scale, w=o.w*App.scale, h=o.h*App.scale;
        uiCtx.strokeStyle = '#0066cc'; uiCtx.lineWidth = 2;
        uiCtx.strokeRect(x,y,w,h);
      }
    }
  }

  // --- INTERACTION ---
  let dragStart = null;

  function getPos(e) {
    const r = uiCanvas.getBoundingClientRect();
    return { x: (e.clientX - r.left)/App.scale, y: (e.clientY - r.top)/App.scale };
  }

  function onMouseDown(e) {
    const {x,y} = getPos(e);
    if(App.tool === 'select') {
      const hit = App.objects.slice().reverse().find(o => x>=o.x && x<=o.x+o.w && y>=o.y && y<=o.y+o.h);
      App.selectedId = hit ? hit.id : null;
      if(hit) {
        dragStart = {x,y, ox:hit.x, oy:hit.y};
        syncProps(hit);
      }
    } else if(App.tool === 'text') {
      addSmartText(x,y);
    } else if(App.tool === 'whiteout') {
      dragStart = {x,y, isNew:true};
    }
    renderUI();
  }

  function onMouseMove(e) {
    const {x,y} = getPos(e);
    if(!dragStart) return;
    
    if(App.tool === 'select' && App.selectedId) {
      const o = App.objects.find(i => i.id === App.selectedId);
      o.x = dragStart.ox + (x - dragStart.x);
      o.y = dragStart.oy + (y - dragStart.y);
      if(o.maskId) {
        const m = App.objects.find(i => i.id === o.maskId);
        if(m) { m.x = o.x; m.y = o.y; }
      }
    }
    renderUI();
  }

  function onMouseUp(e) {
    const {x,y} = getPos(e);
    if(App.tool === 'whiteout' && dragStart && dragStart.isNew) {
      const w = Math.abs(x - dragStart.x);
      const h = Math.abs(y - dragStart.y);
      if(w>5 && h>5) {
        App.objects.push({ id:Date.now(), type:'whiteout', x:Math.min(x,dragStart.x), y:Math.min(y,dragStart.y), w, h });
      }
    }
    dragStart = null;
    renderUI();
  }

  function onDoubleClick(e) {
    const {x,y} = getPos(e);
    const hit = App.objects.find(o => o.type==='text' && x>=o.x && x<=o.x+o.w && y>=o.y && y<=o.y+o.h);
    if(hit) {
      App.selectedId = hit.id;
      startEdit(hit);
    }
  }

  // --- SMART TEXT LOGIC ---
  function addSmartText(x, y) {
    const id = Date.now();
    const maskId = id + 1;
    // 1. Mask
    App.objects.push({ id:maskId, type:'whiteout', x, y, w:120, h:24 });
    // 2. Text
    const txt = {
      id, type:'text', text:'', x, y, w:120, h:24, maskId,
      font: document.getElementById('font-family').value,
      size: parseInt(document.getElementById('font-size').value),
      bold: document.getElementById('btn-bold').classList.contains('active')
    };
    App.objects.push(txt);
    App.selectedId = id;
    setTool('select');
    startEdit(txt);
  }

  function startEdit(o) {
    App.isEditing = true;
    editor.style.display = 'block';
    editor.style.left = (o.x*App.scale) + 'px';
    editor.style.top = (o.y*App.scale) + 'px';
    editor.style.width = (o.w*App.scale) + 'px';
    editor.style.height = (o.h*App.scale*1.2) + 'px'; // extra height
    
    let font = 'Helvetica';
    if(o.font === 'BankCourier') font = '"Courier Prime", monospace';
    if(o.font === 'Times') font = '"Times New Roman", serif';
    
    editor.style.fontFamily = font;
    editor.style.fontSize = (o.size*App.scale) + 'px';
    editor.style.fontWeight = o.bold ? 'bold' : 'normal';
    
    editor.value = o.text;
    editor.focus();
    renderUI();
  }

  function commitEdit() {
    if(!App.isEditing) return;
    const o = App.objects.find(i => i.id === App.selectedId);
    if(o) {
      o.text = editor.value;
      // Auto-resize mask
      const ctx = document.createElement('canvas').getContext('2d');
      ctx.font = `${o.size}px ${o.font}`; 
      const width = ctx.measureText(o.text).width + 20;
      o.w = Math.max(width, 50);
      
      if(o.maskId) {
        const m = App.objects.find(i => i.id === o.maskId);
        if(m) { m.w = o.w; m.h = o.h; }
      }
    }
    App.isEditing = false;
    editor.style.display = 'none';
    renderUI();
  }

  // --- HELPERS ---
  function setTool(t) {
    App.tool = t;
    document.querySelectorAll('.btn-large').forEach(b => b.classList.toggle('active', b.dataset.tool === t));
    uiCanvas.style.cursor = t==='select'?'default':'crosshair';
  }

  function updateProp() {
    if(!App.selectedId) return;
    const o = App.objects.find(i => i.id === App.selectedId);
    if(o && o.type === 'text') {
      o.font = document.getElementById('font-family').value;
      o.size = parseInt(document.getElementById('font-size').value);
      o.bold = document.getElementById('btn-bold').classList.contains('active');
      renderUI();
    }
  }
  
  function syncProps(o) {
    if(o.type !== 'text') return;
    document.getElementById('font-family').value = o.font;
    document.getElementById('font-size').value = o.size;
    if(o.bold) document.getElementById('btn-bold').classList.add('active');
    else document.getElementById('btn-bold').classList.remove('active');
  }

  // --- SAVE ---
  async function savePDF() {
    if(!App.pdfLibDoc) return;
    const doc = App.pdfLibDoc;
    const page = doc.getPages()[App.pageNum-1];
    const {height} = page.getSize();
    
    // Embed Fonts
    const helv = await doc.embedFont(PDFLib.StandardFonts.Helvetica);
    const helvBold = await doc.embedFont(PDFLib.StandardFonts.HelveticaBold);
    const cour = await doc.embedFont(PDFLib.StandardFonts.Courier);
    const courBold = await doc.embedFont(PDFLib.StandardFonts.CourierBold);
    const times = await doc.embedFont(PDFLib.StandardFonts.TimesRoman);

    for(const o of App.objects) {
      const y = height - o.y - o.h;
      
      if(o.type === 'whiteout') {
        page.drawRectangle({ x:o.x, y:y, width:o.w, height:o.h, color: PDFLib.rgb(1,1,1) });
      } else if(o.type === 'text') {
        let font = helv;
        if(o.font === 'BankCourier') font = o.bold ? courBold : cour;
        if(o.font === 'Times') font = times;
        if(o.font === 'Helvetica' && o.bold) font = helvBold;
        
        page.drawText(o.text, {
          x: o.x,
          y: height - o.y - (o.size*0.8),
          size: o.size,
          font: font,
          color: PDFLib.rgb(0,0,0)
        });
      }
    }
    
    const bytes = await doc.save();
    const blob = new Blob([bytes], {type:'application/pdf'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'edited_doc.pdf';
    a.click();
  }
</script>
</body>
</html>
